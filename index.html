<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUT FLIPS - Live Sniper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117; --bg-med: #161b22; --accent-primary: #00A8FF;
            --accent-secondary: #0056b3; --text-light: #c9d1d9; --glow-color: rgba(0, 168, 255, 0.7);
            --profit-color: #28a745; --loss-color: #dc3545;
        }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-light);
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px; animation: bg-pan 120s linear infinite;
        }
        @keyframes bg-pan { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .card-container { animation: fadeIn 0.5s ease-out forwards; }
        .card { background: linear-gradient(145deg, var(--bg-med), #0d1117); border: 1px solid var(--accent-secondary); border-radius: 0.5rem; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(0, 86, 179, 0.2); height: 100%; }
        .card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 0 30px var(--glow-color); }
        .control-panel { background-color: rgba(13, 17, 23, 0.8); backdrop-filter: blur(10px); border: 1px solid var(--accent-secondary); border-radius: 0.5rem; }
        .host-input, .tracker-input { background-color: var(--bg-dark); border: 1px solid var(--accent-primary); color: var(--text-light); border-radius: 0.25rem; padding: 0.75rem 1rem; }
        .btn { background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); color: white; font-weight: 600; border-radius: 0.25rem; transition: all 0.3s ease; padding: 0.75rem 1.5rem; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 0 10px rgba(0, 168, 255, 0.5); }
        .btn.active { box-shadow: 0 0 25px var(--glow-color); transform: scale(1.02); }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--glow-color); }
        .btn:disabled { background: #374151; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-danger { background: linear-gradient(45deg, #b30000, #ff4d4d); box-shadow: 0 0 10px rgba(255, 77, 77, 0.5); }
        .btn-danger:hover { box-shadow: 0 0 20px rgba(255, 77, 77, 0.8); }
        .main-tab-btn { border-bottom: 3px solid transparent; padding: 0.75rem 1rem; transition: all 0.2s ease-in-out; white-space: nowrap; }
        .main-tab-btn.active { color: var(--accent-primary); border-color: var(--accent-primary); }
        .console-btn.active { background-color: var(--accent-primary); color: white; }
        .console-btn:not(.active) { background-color: var(--bg-med); color: var(--text-light); }
        .median-btn.active { background-color: var(--accent-primary); color: white; }
        .median-btn:not(.active) { background-color: var(--bg-dark); color: var(--text-light); border: 1px solid var(--accent-secondary) }
        .profit-value, .gap-value, .ratio-value { color: var(--accent-primary); text-shadow: 0 0 8px var(--glow-color); }
        .header-title { text-shadow: 0 0 15px var(--glow-color); }
        .main-tab-content { display: none; }
        .main-tab-content.active { display: block; }
        .tracker-table th { background-color: #374151; }
        .tracker-table tr:nth-child(even) { background-color: #1f2937; }
        .tracker-table tr:nth-child(odd) { background-color: #273345; }
        .tracker-table .cheapest-ratio { font-weight: bold; background-color: rgba(40, 167, 69, 0.2); }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-screen-2xl mx-auto">
        <header class="flex flex-col md:relative items-center justify-center mb-8">
            <div class="header-title-container text-center">
                <h1 class="header-title text-5xl font-bold text-white uppercase">CUT FLIPS</h1>
                <p id="page-mode" class="text-lg text-gray-400 mt-2">Mode: <span class="font-bold text-[var(--accent-primary)]">View-Only</span></p>
            </div>
            <div class="mt-4 md:absolute md:top-0 md:right-0 md:mt-4 md:mr-4">
                <div id="consoleSelector" class="flex space-x-1 bg-gray-900 p-1 rounded-lg">
                    <button data-console="xbox" class="console-btn active text-sm font-bold py-2 px-4 rounded-md">Xbox</button>
                    <button data-console="playstation" class="console-btn text-sm font-bold py-2 px-4 rounded-md">PS5</button>
                </div>
            </div>
        </header>

        <div class="control-panel p-6 rounded-xl shadow-lg mb-8 sticky top-4 z-10">
            <div id="host-controls" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Sniper Scanner</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">OVR Range</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="minOvrInput" placeholder="Min" value="84" class="host-input w-full">
                                    <span class="text-gray-400">-</span>
                                    <input type="number" id="maxOvrInput" placeholder="Max" value="87" class="host-input w-full">
                                </div>
                            </div>
                            <div>
                                <label for="promoInput" class="block text-sm font-medium text-gray-300 mb-2">Promo Name (Optional)</label>
                                <input type="text" id="promoInput" placeholder="e.g. Legends" class="host-input w-full">
                            </div>
                             <div class="flex items-center gap-4">
                                <button id="toggleSniperScannerBtn" class="btn w-full py-2">Start Sniper</button>
                                <div id="sniperStatus" class="flex-grow text-center text-gray-400 text-sm h-5"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Training Sniper</h3>
                         <p class="text-xs text-gray-400 mb-4">This scanner independently and continuously scans the top 5 cheapest training OVRs.</p>
                         <div class="flex items-center gap-4">
                            <button id="toggleTrainingScannerBtn" class="btn w-full py-2">Start Training</button>
                            <div id="trainingStatus" class="flex-grow text-center text-gray-400 text-sm h-5"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-700 text-center">
                     <button id="clearDbBtn" class="btn btn-danger py-2 px-6">Clear All Feeds</button>
                </div>
            </div>

            <div id="viewer-filters">
                <div id="sniper-filters-panel" class="hidden">
                    <div class="flex flex-wrap gap-6 items-end">
                        <div class="flex-none">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Recent Sales</label>
                            <div id="medianTypeFilter" class="flex space-x-1 bg-gray-900 p-1 rounded-lg">
                                <button data-median="20" class="median-btn active flex-1 text-center py-2 px-3 rounded-md text-xs">20</button>
                                <button data-median="10" class="median-btn active flex-1 text-center py-2 px-3 rounded-md text-xs">10</button>
                                <button data-median="5" class="median-btn active flex-1 text-center py-2 px-3 rounded-md text-xs">5</button>
                                <button data-median="3" class="median-btn active flex-1 text-center py-2 px-3 rounded-md text-xs">3</button>
                            </div>
                        </div>
                        <div class="flex-grow min-w-[150px]">
                            <label for="profitSlider" class="block text-sm font-medium text-gray-300 mb-2">Min Profit: <span id="profitValue" class="profit-value font-bold">10,000</span></label>
                            <input id="profitSlider" type="range" min="5000" max="200000" step="1000" value="10000" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="flex-grow min-w-[150px]">
                            <label for="priceGapSlider" class="block text-sm font-medium text-gray-300 mb-2">Min % Gap: <span id="gapValue" class="gap-value font-bold">20%</span></label>
                            <input id="priceGapSlider" type="range" min="5" max="100" step="5" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
                <div id="training-sniper-filters-panel" class="hidden">
                     <div class="flex-grow min-w-[150px]">
                        <label for="ratioSlider" class="block text-sm font-medium text-gray-300 mb-2">Max Ratio: <span id="ratioValue" class="ratio-value font-bold">90</span></label>
                        <input id="ratioSlider" type="range" min="1" max="150" step="1" value="90" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-8 flex justify-center border-b border-gray-700 overflow-x-auto hide-scrollbar">
            <div class="flex">
                <button id="main-tab-home" class="main-tab-btn active px-6 py-3 text-lg font-medium">Home</button>
                <button id="main-tab-sniper" class="main-tab-btn px-6 py-3 text-lg font-medium">Sniper</button>
                <button id="main-tab-average" class="main-tab-btn px-6 py-3 text-lg font-medium">Below Average</button>
                <button id="main-tab-training" class="main-tab-btn px-6 py-3 text-lg font-medium">Training Sniper</button>
                <button id="main-tab-tracker" class="main-tab-btn px-6 py-3 text-lg font-medium">Tracker</button>
            </div>
        </div>

        <div id="home-content" class="main-tab-content active">
            <main id="homeFeed" class="text-center text-gray-400 mb-6">Welcome! Loading training data...</main>
            <div id="training-filters" class="mb-4 flex space-x-2 justify-center">
                <button data-sort="cheapestRatio" class="btn active py-1 px-2 text-sm">Cheapest Ratio</button>
                <button data-sort="ovrHighToLow" class="btn py-1 px-2 text-sm">OVR High-Low</button>
                <button data-sort="ovrLowToHigh" class="btn py-1 px-2 text-sm">OVR Low-High</button>
            </div>
            <div id="trainingTableContainer" class="overflow-x-auto">
                <table class="min-w-full text-left text-sm font-light text-surface tracker-table">
                    <thead class="font-medium">
                        <tr><th class="px-6 py-4">OVR</th><th class="px-6 py-4">Training</th><th class="px-6 py-4">Ratio</th><th class="px-6 py-4">Price</th></tr>
                    </thead>
                    <tbody id="trainingTableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="sniper-content" class="main-tab-content">
            <main id="sniperFeed" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6"></main>
        </div>
        <div id="average-content" class="main-tab-content">
            <main id="averageFeed" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6"></main>
        </div>
        <div id="training-sniper-content" class="main-tab-content">
            <main id="trainingSniperFeed" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6"></main>
        </div>
        <div id="tracker-content" class="main-tab-content">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                <div class="bg-[var(--bg-med)] p-4 rounded-lg"><p class="text-sm text-gray-400">Daily Profit</p><p id="dailyProfit" class="text-2xl font-bold text-[var(--profit-color)]">0</p></div>
                <div class="bg-[var(--bg-med)] p-4 rounded-lg"><p class="text-sm text-gray-400">Weekly Profit</p><p id="weeklyProfit" class="text-2xl font-bold text-[var(--profit-color)]">0</p></div>
                <div class="bg-[var(--bg-med)] p-4 rounded-lg"><p class="text-sm text-gray-400">Monthly Profit</p><p id="monthlyProfit" class="text-2xl font-bold text-[var(--profit-color)]">0</p></div>
                <div class="bg-[var(--bg-med)] p-4 rounded-lg"><p class="text-sm text-gray-400">All-Time Profit</p><p id="allTimeProfit" class="text-2xl font-bold text-[var(--profit-color)]">0</p></div>
            </div>
            <div class="bg-[var(--bg-med)] p-4 rounded-lg mb-8">
                <h3 class="text-xl font-bold mb-4">Add a New Flip</h3>
                <form id="add-flip-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-2"><label for="trackerName" class="block text-sm mb-1">Player Name</label><input type="text" id="trackerName" required class="tracker-input w-full"></div>
                    <div><label for="trackerOvr" class="block text-sm mb-1">OVR</label><input type="number" id="trackerOvr" required class="tracker-input w-full"></div>
                    <div><label for="trackerBuyPrice" class="block text-sm mb-1">Buy Price</label><input type="number" id="trackerBuyPrice" required class="tracker-input w-full"></div>
                    <div class="md:col-span-1"><button type="submit" class="btn w-full py-3">Add</button></div>
                </form>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm font-light text-surface tracker-table">
                    <thead class="font-medium"><tr><th class="px-6 py-4">Player</th><th class="px-6 py-4">Buy Price</th><th class="px-6 py-4">Sell Price</th><th class="px-6 py-4">Profit (Taxed)</th><th class="px-6 py-4">Actions</th></tr></thead>
                    <tbody id="tracker-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        'use strict';

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyNZGfhc0lJi14TJzlRDngFUFY47LCoBk",
            authDomain: "snipes-31c9e.firebaseapp.com",
            databaseURL: "https://snipes-31c9e-default-rtdb.firebaseio.com",
        };
        const CONCURRENT_CHECKS = 8;
        const SNIPE_MAX_AGE_MS = 10 * 60 * 1000;
        const CLEANUP_INTERVAL_MS = 30 * 1000;
        const TIMESTAMP_UPDATE_INTERVAL_MS = 5000;

        // --- App State ---
        let db, isHost = false, sniperHelperReady = false;
        let sniperScannerRunning = false, trainingScannerRunning = false;
        let allSnipes = new Map(), averageDeals = new Map(), trainingSnipes = new Map(), priceHistory = {}, trackedFlips = [];
        let playerListCache = []; 
        let cacheFilters = {}; 
        let trainingDataCache = null, currentTrainingSort = 'cheapestRatio';
        let trainingScanProgress = {};
        let statusUpdateInterval = null;
        let currentConsole = 'xbox';
        let currentFilters = { medians: [20, 10, 5, 3], minProfit: 10000, priceGap: 0.20, maxRatio: 90 };
        let userId = localStorage.getItem('cutflips_userId') || `user_${crypto.randomUUID()}`;
        localStorage.setItem('cutflips_userId', userId);

        // --- UI Elements ---
        const ui = {
            pageMode: document.getElementById('page-mode'),
            consoleSelector: document.getElementById('consoleSelector'), 
            sniperFeed: document.getElementById('sniperFeed'),
            averageFeed: document.getElementById('averageFeed'), 
            trainingSniperFeed: document.getElementById('trainingSniperFeed'),
            homeFeed: document.getElementById('homeFeed'), 
            trainingTableBody: document.getElementById('trainingTableBody'),
            trainingFilters: document.getElementById('training-filters'),
            hostControls: document.getElementById('host-controls'),
            sniperStatus: document.getElementById('sniperStatus'),
            trainingStatus: document.getElementById('trainingStatus'),
            minOvrInput: document.getElementById('minOvrInput'), 
            maxOvrInput: document.getElementById('maxOvrInput'),
            promoInput: document.getElementById('promoInput'), 
            toggleSniperScannerBtn: document.getElementById('toggleSniperScannerBtn'),
            toggleTrainingScannerBtn: document.getElementById('toggleTrainingScannerBtn'),
            clearDbBtn: document.getElementById('clearDbBtn'), 
            sniperFiltersPanel: document.getElementById('sniper-filters-panel'),
            trainingSniperFiltersPanel: document.getElementById('training-sniper-filters-panel'),
            medianTypeFilter: document.getElementById('medianTypeFilter'), 
            profitSlider: document.getElementById('profitSlider'),
            profitValue: document.getElementById('profitValue'), 
            priceGapSlider: document.getElementById('priceGapSlider'),
            gapValue: document.getElementById('gapValue'), 
            ratioSlider: document.getElementById('ratioSlider'),
            ratioValue: document.getElementById('ratioValue'), 
            tabs: document.querySelectorAll('.main-tab-btn'),
            tabContents: document.querySelectorAll('.main-tab-content'),
            tracker: {
                form: document.getElementById('add-flip-form'), tableBody: document.getElementById('tracker-table-body'),
                dailyProfit: document.getElementById('dailyProfit'), weeklyProfit: document.getElementById('weeklyProfit'),
                monthlyProfit: document.getElementById('monthlyProfit'), allTimeProfit: document.getElementById('allTimeProfit'),
            }
        };

        // --- Initialization ---
        async function initializeApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
            } catch(e) {
                document.body.innerHTML = `<div class="text-red-500 text-center p-8">FATAL: Firebase failed to initialize. ${e.message}</div>`;
                return;
            }

            sniperHelperReady = await checkSniperHelper();
            if (sniperHelperReady) {
                isHost = true;
                ui.pageMode.innerHTML = 'Mode: <span class="font-bold text-green-400">Host</span>';
                ui.hostControls.classList.remove('hidden');
            }
            
            initializeEventListeners();
            initializeFirebaseListeners();
            switchMainTab('home');
            setInterval(cleanOldItems, CLEANUP_INTERVAL_MS);
            setInterval(updateTimestamps, TIMESTAMP_UPDATE_INTERVAL_MS);
        }

        function checkSniperHelper() {
            return new Promise(resolve => {
                if (window.isSniperHelperLoaded) return resolve(true);
                let timeout = setTimeout(() => resolve(false), 2000);
                document.addEventListener('sniper-helper-loaded', () => {
                    window.isSniperHelperLoaded = true;
                    clearTimeout(timeout);
                    resolve(true);
                }, { once: true });
            });
        }

        // --- Firebase Logic ---
        function initializeFirebaseListeners() {
            const now = Date.now();
            const listenForNewItems = (path, map, renderFn) => {
                db.ref(path).orderByChild('timestamp').startAt(now).on('child_added', s => handleItem(s, map, renderFn));
            };
            
            listenForNewItems('snipes', allSnipes, renderNewSnipe);
            listenForNewItems('averageDeals', averageDeals, renderNewAverageDeal);
            listenForNewItems('trainingSnipes', trainingSnipes, renderNewTrainingSnipe);

            db.ref(`trackedFlips/${userId}`).on('value', snapshot => {
                const data = snapshot.val();
                trackedFlips = data ? Object.values(data).sort((a,b) => b.timestamp - a.timestamp) : [];
                renderTrackerTable();
            });
        }
        
        function handleItem(snapshot, dataMap, renderFn) {
            const item = snapshot.val();
            if (item && !dataMap.has(item.id)) {
                dataMap.set(item.id, item);
                renderFn(item);
            }
        }

        // --- Host Scanner Logic ---
        async function runSniperCycle() {
            if (!sniperScannerRunning || !isHost) return;

            const currentScanFilters = {
                minOvr: ui.minOvrInput.value, maxOvr: ui.maxOvrInput.value, promo: ui.promoInput.value.trim()
            };
            const filtersChanged = JSON.stringify(currentScanFilters) !== JSON.stringify(cacheFilters);

            if (playerListCache.length === 0 || filtersChanged) {
                ui.sniperStatus.textContent = 'Building player list...';
                const { minOvr, maxOvr, promo } = currentScanFilters;
                let fullList = [];
                for (let ovr = parseInt(minOvr); ovr <= parseInt(maxOvr); ovr++) {
                    if (!sniperScannerRunning) break;
                    ui.sniperStatus.textContent = `Fetching ${ovr} OVR players...`;
                    const playersForOvr = await fetchAllPlayerPages({ minOvr: ovr, maxOvr: ovr, promo });
                    if (playersForOvr?.length > 0) fullList.push(...playersForOvr);
                }
                
                if (fullList.length === 0) {
                    ui.sniperStatus.innerHTML = '<span class="text-red-400">No players found.</span>';
                    setTimeout(runSniperCycle, 5000);
                    return;
                }
                playerListCache = fullList;
                cacheFilters = currentScanFilters;
            }
            
            await processSniperQueue(playerListCache);
            if (sniperScannerRunning) {
                ui.sniperStatus.textContent = 'Scan complete. Waiting...';
                setTimeout(runSniperCycle, 15000);
            }
        }
        
        async function startTrainingScan() {
            if (!trainingScannerRunning || !isHost) return;

            // Start the UI update interval
            if(statusUpdateInterval) clearInterval(statusUpdateInterval);
            statusUpdateInterval = setInterval(updateTrainingStatusUI, 1200);

            ui.trainingStatus.textContent = 'Getting training data...';
            await fetchTrainingData();
            if (!trainingDataCache) {
                 ui.trainingStatus.innerHTML = '<span class="text-red-400">Data unavailable. Retrying...</span>';
                 setTimeout(startTrainingScan, 30000);
                 return;
            }

            const topTrainingOVRs = [...trainingDataCache].sort((a,b) => a.trainingRatio - b.trainingRatio).slice(0, 5).map(item => item.overall);
            
            // Initialize the progress tracker
            trainingScanProgress = {};
            topTrainingOVRs.forEach(ovr => {
                trainingScanProgress[ovr] = { remaining: '...' }; // Initial "fetching" state
            });
            
            // Launch an independent, continuous loop for each OVR.
            topTrainingOVRs.forEach(ovr => scanOvrForTraining(ovr));
        }

        async function scanOvrForTraining(ovr) {
            // This function creates a self-sustaining loop for a single OVR.
            if (!trainingScannerRunning) {
                delete trainingScanProgress[ovr];
                return;
            }
            
            // Fetch all pages for this specific OVR
            const playerList = await fetchAllPlayerPages({minOvr: ovr, maxOvr: ovr, promo: ''}, 999); 

            if (playerList?.length > 0) {
                trainingScanProgress[ovr] = { remaining: playerList.length };
                await processTrainingQueue(playerList, ovr);
            }
            
            trainingScanProgress[ovr].remaining = 0; // Mark as done for this cycle

            // After finishing, wait a bit and then start over for this same OVR.
            if (trainingScannerRunning) {
                await new Promise(resolve => setTimeout(resolve, 15000));
                scanOvrForTraining(ovr);
            }
        }

        function updateTrainingStatusUI() {
            if(!trainingScannerRunning) {
                ui.trainingStatus.textContent = 'Scanner stopped.';
                if(statusUpdateInterval) clearInterval(statusUpdateInterval);
                return;
            }
            const progressParts = Object.entries(trainingScanProgress).map(([ovr, progress]) => {
                if (progress.remaining === '...') return `${ovr}&nbsp;(...)`;
                if (progress.remaining === 0) return `<span class="text-green-400">${ovr}&nbsp;✓</span>`;
                return `${ovr}&nbsp;(${progress.remaining})`;
            });
            if (progressParts.length > 0) {
                ui.trainingStatus.innerHTML = `Scanning: ${progressParts.join(', ')}`;
            }
        }

        function fetchAllPlayerPages(filters, pageLimit = 999) {
            return new Promise(async (resolve) => {
                let currentPage = 1, hasMore = true, fullList = [];
                // Allow either scanner to keep this loop alive
                while((sniperScannerRunning || trainingScannerRunning) && hasMore && currentPage <= pageLimit) {
                    const result = await fetchHelperData({ type: 'playerList', page: currentPage, filters });
                    const playersOnPage = result?.players;
                    if (playersOnPage?.length > 0) {
                        fullList.push(...playersOnPage);
                        currentPage++;
                    } else { hasMore = false; }
                }
                resolve(fullList);
            });
        }
        
        async function processSniperQueue(playerList) {
            let playersToProcess = [...playerList]; 
            const worker = async () => {
                while (sniperScannerRunning && playersToProcess.length > 0) {
                    const player = playersToProcess.shift();
                    if (!player) continue;
                    ui.sniperStatus.textContent = `Scanning ${playersToProcess.length} players...`;
                    
                    const platformPromises = ['xbox-series-x', 'playstation-5'].map(platform => 
                        fetchHelperData({ type: 'playerPrices', player, platform }).then(data => {
                            if (data) return checkPriceForSnipe(player, platform, data);
                        })
                    );
                    await Promise.all(platformPromises);
                }
            };
            await Promise.all(Array(CONCURRENT_CHECKS).fill(null).map(worker));
        }

        async function processTrainingQueue(playerList, ovr) {
            let playersToProcess = [...playerList]; 
            const worker = async () => {
                while (trainingScannerRunning && playersToProcess.length > 0) {
                    const player = playersToProcess.shift();
                    if (!player) continue;
                    
                    const platformPromises = ['xbox-series-x', 'playstation-5'].map(platform => 
                        fetchHelperData({ type: 'playerPrices', player, platform }).then(data => {
                            if (data) return checkPriceForTraining(player, platform, data);
                        })
                    );
                    await Promise.all(platformPromises);
                    if (trainingScanProgress[ovr]) trainingScanProgress[ovr].remaining--;
                }
            };
            await Promise.all(Array(CONCURRENT_CHECKS).fill(null).map(worker));
        }
        
        async function checkPriceForTraining(player, platform, data) {
            if (!trainingDataCache) return;
            const { priceData, portraitUrl } = data;
            const liveAuctions = priceData?.pricesData?.liveAuctions; 
            if (!liveAuctions?.length) return;

            const trainingInfo = trainingDataCache.find(t => t.overall == player.ovr);
            if (!trainingInfo || trainingInfo.quicksellAmount === 0) return;

            for (const auction of liveAuctions) {
                const buyNowPrice = parseInt(auction.buyNowPrice, 10);
                if (!Number.isFinite(buyNowPrice)) continue;

                const currentRatio = buyNowPrice / trainingInfo.quicksellAmount;
                if (currentRatio <= trainingInfo.trainingRatio * 1.05 && currentRatio <= currentFilters.maxRatio) {
                    const trainingSnipeId = `ts-${player.uniqueId}-${platform}-${buyNowPrice}-${Math.random().toString().substring(2)}`; 
                    
                    const isVerified = await verifySnipe(player, platform, buyNowPrice);
                    if(isVerified) {
                        const trainingSnipe = { id: trainingSnipeId, player: {...player, portraitUrl}, platform, buyNowPrice, ratio: currentRatio, quicksellAmount: trainingInfo.quicksellAmount, timestamp: Date.now() };
                        handleItem({val: () => trainingSnipe}, trainingSnipes, renderNewTrainingSnipe);
                        db.ref(`trainingSnipes/${trainingSnipe.id}`).set({ ...trainingSnipe, timestamp: firebase.database.ServerValue.TIMESTAMP });
                    }
                }
            }
        }
        
        async function checkPriceForSnipe(player, platform, data) {
            player.image = player.image || ''; 
            const { priceData, portraitUrl } = data;
            if (!priceData?.pricesData?.liveAuctions?.length) return;
            const liveAuctions = priceData.pricesData.liveAuctions.map(a => parseInt(a.buyNowPrice, 10)).filter(Number.isFinite).sort((a,b) => a - b);
            if (!liveAuctions.length) return;

            const cheapestAuction = liveAuctions[0];
            const now = Date.now();
            const historyKey = `${player.uniqueId}-${platform}`;

            if (!priceHistory[historyKey]) priceHistory[historyKey] = [];
            priceHistory[historyKey].push({ price: cheapestAuction, timestamp: now });
            priceHistory[historyKey] = priceHistory[historyKey].filter(p => now - p.timestamp < 6 * 3600 * 1000);
            if (priceHistory[historyKey].length > 5 && cheapestAuction < (priceHistory[historyKey].reduce((s, p) => s + p.price, 0) / priceHistory[historyKey].length) * 0.85) {
                const deal = { id: `${player.uniqueId}-avg`, player: {...player, portraitUrl}, platform, buyNowPrice: cheapestAuction, averagePrice: priceHistory[historyKey].reduce((s, p) => s + p.price, 0) / priceHistory[historyKey].length, timestamp: now };
                handleItem({val: () => deal}, averageDeals, renderNewAverageDeal);
                db.ref(`averageDeals/${deal.id}`).set({ ...deal, timestamp: firebase.database.ServerValue.TIMESTAMP });
            }
            
            let priceGap = null;
            if (liveAuctions.length > 1) {
                priceGap = (liveAuctions[1] - cheapestAuction) / cheapestAuction;
                if (priceGap < currentFilters.priceGap) return;
            }

            for (const n of currentFilters.medians) {
                const median = calculateMedianOfLastNSales(priceData, n);
                if (median > 0 && cheapestAuction < median) {
                    const profit = Math.round((median * 0.9) - cheapestAuction);
                    if (profit >= currentFilters.minProfit) {
                        const snipeId = `${player.uniqueId}-${platform}-${cheapestAuction}`;
                        if (allSnipes.has(snipeId)) continue;
                        
                        const isVerified = await verifySnipe(player, platform, cheapestAuction);
                        if (isVerified) {
                            const snipe = { id: snipeId, player: {...player, portraitUrl}, platform, buyNowPrice: cheapestAuction, median, profit, medianType: n, priceGap: priceGap, timestamp: now };
                            handleItem({val: () => snipe}, allSnipes, renderNewSnipe);
                            const consoleName = platform === 'xbox-series-x' ? 'Xbox' : 'PS5';
                            console.log(`%cSNIPE SENT: %c${snipe.player.name} on ${consoleName} for ${snipe.buyNowPrice.toLocaleString()}. Profit: ${snipe.profit.toLocaleString()}`, 'color: #00A8FF; font-weight: bold;', 'color: inherit;');
                            db.ref(`snipes/${snipe.id}`).set({ ...snipe, timestamp: firebase.database.ServerValue.TIMESTAMP });
                        }
                        break; 
                    }
                }
            }
        }

        async function verifySnipe(player, platform, buyNowPrice) {
            // console.log(`Verifying item for ${player.name} at ${buyNowPrice.toLocaleString()}...`);
            const data = await fetchHelperData({ type: 'playerPrices', player, platform });
            const liveAuctions = data?.priceData?.pricesData?.liveAuctions;
            if (!liveAuctions) {
                // console.warn(`Verification FAILED for ${player.name}: Could not re-fetch auctions.`);
                return false;
            }
            return liveAuctions.some(a => parseInt(a.buyNowPrice, 10) === buyNowPrice);
        }

        // --- UI Rendering ---
        function renderNewSnipe(snipe) { ui.sniperFeed.prepend(createCard(snipe)); applyAllFilters(); }
        function renderNewAverageDeal(deal) { ui.averageFeed.prepend(createCard(deal, true)); applyAllFilters(); }
        function renderNewTrainingSnipe(item) { ui.trainingSniperFeed.prepend(createCard(item, false, true)); applyAllFilters(); }

        function createCard(item, isAverageDeal = false, isTrainingSnipe = false) {
            const existing = document.getElementById(item.id);
            if (existing) existing.remove();
            const card = document.createElement('div');
            card.className = 'card-container';
            card.id = item.id;
            card.dataset.console = item.platform;
            card.dataset.timestamp = item.timestamp;

            if (isTrainingSnipe) {
                card.dataset.ratio = item.ratio;
            } else if (!isAverageDeal) { 
                card.dataset.medianType = item.medianType; 
                card.dataset.profit = item.profit;
                card.dataset.priceGap = item.priceGap === null ? 9999 : item.priceGap;
            }

            let value, colorClass, label, bottomMetric, bottomLabel;
            if (isTrainingSnipe) {
                value = item.ratio;
                colorClass = 'text-purple-400';
                label = 'Actual Ratio';
                bottomMetric = item.quicksellAmount ? item.quicksellAmount.toLocaleString() : 'N/A';
                bottomLabel = 'Training';
            } else if (isAverageDeal) {
                value = item.averagePrice - item.buyNowPrice;
                colorClass = value > 50000 ? 'text-[var(--accent-primary)]' : 'text-green-400';
                label = 'Discount';
                bottomMetric = Math.round(item.averagePrice).toLocaleString();
                bottomLabel = '6hr Avg';
            } else {
                value = item.profit;
                colorClass = value > 50000 ? 'text-[var(--accent-primary)]' : 'text-green-400';
                label = 'Est. Profit';
                bottomMetric = item.median.toLocaleString();
                bottomLabel = `${item.medianType}-Sale`;
            }
            
            card.innerHTML = `<a href="${item.player.link}" target="_blank" rel="noopener noreferrer"><div class="card p-4 flex flex-col h-full"><div class="relative"><img src="${item.player.portraitUrl || ''}" alt="${item.player.name}" class="w-full h-auto rounded-md" onerror="this.style.display='none'"><div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xl font-bold px-3 py-1 rounded-full">${item.player.ovr}</div></div><div class="flex-grow mt-4 flex flex-col"><h3 class="text-lg font-semibold text-white truncate">${item.player.name}</h3><div class="flex justify-between items-center"><p class="text-sm text-gray-400">${item.player.promo||'Core'}</p><p class="time-ago text-xs text-gray-500">Just now</p></div><div class="mt-4 grid grid-cols-2 gap-x-4 text-sm"><div><p class="text-gray-400">Price</p><p class="font-bold text-lg">${(item.buyNowPrice||0).toLocaleString()}</p></div><div><p class="text-gray-400">${bottomLabel}</p><p class="font-bold text-lg">${bottomMetric}</p></div></div><div class="mt-4 pt-4 border-t border-gray-700"><p class="text-gray-400 text-sm">${label}</p><p class="font-bold text-2xl ${colorClass}">${isTrainingSnipe ? value.toFixed(2) : Math.round(value).toLocaleString()}</p></div></div></div></a>`;
            return card;
        }

        function renderTrainingData() {
            if (!trainingDataCache || trainingDataCache.length === 0) {
                if (isHost) ui.homeFeed.textContent = 'Host: Click Home tab to fetch Training Data.';
                else ui.homeFeed.textContent = 'Waiting for Host to provide Training Data...';
                ui.trainingTableBody.innerHTML = '';
                return;
            }
            ui.homeFeed.textContent = 'Training data is based on the cheapest prices for each OVR.';
            ui.trainingTableBody.innerHTML = '';
            
            const sortedData = [...trainingDataCache].sort((a,b) => {
                switch(currentTrainingSort) {
                    case 'ovrHighToLow': return b.overall - a.overall;
                    case 'ovrLowToHigh': return a.overall - b.overall;
                    default: return a.trainingRatio - b.trainingRatio;
                }
            });

            const cheapestRatio = [...trainingDataCache].sort((a,b) => a.trainingRatio - b.trainingRatio)[0]?.trainingRatio || 0;
            sortedData.forEach(item => {
                const row = document.createElement('tr');
                if (item.trainingRatio === cheapestRatio && cheapestRatio > 0) row.classList.add('cheapest-ratio');
                row.innerHTML = `<td class="px-6 py-4">${item.overall}</td><td class="px-6 py-4">${item.quicksellAmount.toLocaleString()}</td><td class="px-6 py-4">${item.trainingRatio.toFixed(2)}</td><td class="px-6 py-4">${item.price.toLocaleString()}</td>`;
                ui.trainingTableBody.appendChild(row);
            });
        }

        function renderTrackerTable() {
            ui.tracker.tableBody.innerHTML = '';
            let daily=0, weekly=0, monthly=0, allTime=0;
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const weekStart = new Date(new Date().setDate(now.getDate() - now.getDay())).getTime();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

            trackedFlips.forEach(flip => {
                const profit = flip.sellPrice ? Math.round((flip.sellPrice * 0.9) - flip.buyPrice) : 0;
                if (flip.sellPrice) {
                    const flipDate = new Date(flip.timestamp);
                    if (flipDate.getTime() >= todayStart) daily += profit;
                    if (flipDate.getTime() >= weekStart) weekly += profit;
                    if (flipDate.getTime() >= monthStart) monthly += profit;
                    allTime += profit;
                }
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-2">${flip.name} ${flip.ovr}</td><td class="p-2">${flip.buyPrice.toLocaleString()}</td><td class="p-2"><input type="number" data-id="${flip.id}" value="${flip.sellPrice||''}" class="tracker-input sell-price-input w-28 text-sm p-1"></td><td class="p-2 font-bold ${profit > 0 ? 'text-green-400' : 'text-red-400'}">${profit.toLocaleString()}</td><td class="p-2"><button data-id="${flip.id}" class="remove-flip-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Remove</button></td>`;
                ui.tracker.tableBody.appendChild(row);
            });
            ui.tracker.dailyProfit.textContent = daily.toLocaleString();
            ui.tracker.weeklyProfit.textContent = weekly.toLocaleString();
            ui.tracker.monthlyProfit.textContent = monthly.toLocaleString();
            ui.tracker.allTimeProfit.textContent = allTime.toLocaleString();
        }

        // --- Event Listeners ---
        function initializeEventListeners() {
            ui.consoleSelector.addEventListener('click', e => {
                if (e.target.tagName !== 'BUTTON') return;
                currentConsole = e.target.dataset.console;
                ui.consoleSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                trainingDataCache = null; 
                fetchTrainingData();
                applyAllFilters();
            });

            ui.tabs.forEach(tab => tab.addEventListener('click', () => switchMainTab(tab.id.replace('main-tab-',''))));
            
            if (isHost) {
                ui.toggleSniperScannerBtn.addEventListener('click', () => {
                    sniperScannerRunning = !sniperScannerRunning;
                    ui.toggleSniperScannerBtn.textContent = sniperScannerRunning ? 'Stop Sniper' : 'Start Sniper';
                    ui.toggleSniperScannerBtn.classList.toggle('btn-danger', sniperScannerRunning);
                    if (sniperScannerRunning) {
                        playerListCache = []; 
                        runSniperCycle(); 
                    }
                    else ui.sniperStatus.textContent = 'Scanner stopped.';
                });
                ui.toggleTrainingScannerBtn.addEventListener('click', () => {
                    trainingScannerRunning = !trainingScannerRunning;
                    ui.toggleTrainingScannerBtn.textContent = trainingScannerRunning ? 'Stop Training' : 'Start Training';
                    ui.toggleTrainingScannerBtn.classList.toggle('btn-danger', trainingScannerRunning);
                    if (trainingScannerRunning) {
                        startTrainingScan();
                    } else {
                        ui.trainingStatus.textContent = 'Scanner stopped.';
                        if(statusUpdateInterval) clearInterval(statusUpdateInterval);
                    }
                });
                ui.clearDbBtn.addEventListener('click', () => {
                    if (confirm('Clear ALL snipes, deals, and training from database?')) {
                        db.ref('snipes').remove(); db.ref('averageDeals').remove(); db.ref('trainingSnipes').remove();
                        allSnipes.clear(); averageDeals.clear(); trainingSnipes.clear();
                        ui.sniperFeed.innerHTML = ''; ui.averageFeed.innerHTML = ''; ui.trainingSniperFeed.innerHTML = '';
                    }
                });
            }

            ui.medianTypeFilter.addEventListener('click', e => {
                if (e.target.classList.contains('median-btn')) {
                    e.target.classList.toggle('active');
                    currentFilters.medians = Array.from(ui.medianTypeFilter.querySelectorAll('.active')).map(b=>parseInt(b.dataset.median,10));
                    applyAllFilters();
                }
            });
            ui.profitSlider.addEventListener('input', e => {
                currentFilters.minProfit = parseInt(e.target.value, 10);
                ui.profitValue.textContent = currentFilters.minProfit.toLocaleString();
                applyAllFilters();
            });
            ui.priceGapSlider.addEventListener('input', e => {
                currentFilters.priceGap = parseInt(e.target.value, 10) / 100;
                ui.gapValue.textContent = `${e.target.value}%`;
            });
            ui.ratioSlider.addEventListener('input', e => {
                currentFilters.maxRatio = parseInt(e.target.value, 10);
                ui.ratioValue.textContent = currentFilters.maxRatio;
                applyAllFilters();
            });

            ui.trainingFilters.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    currentTrainingSort = e.target.dataset.sort;
                    ui.trainingFilters.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderTrainingData();
                }
            });

            ui.tracker.form.addEventListener('submit', e => {
                e.preventDefault();
                const form = e.target;
                const flip = {
                    id: `flip-${Date.now()}`, name: form.trackerName.value, ovr: form.trackerOvr.value,
                    buyPrice: parseInt(form.trackerBuyPrice.value, 10), sellPrice: null, timestamp: Date.now()
                };
                if (!flip.name || !flip.ovr || !flip.buyPrice) return;
                db.ref(`trackedFlips/${userId}/${flip.id}`).set(flip);
                form.reset();
            });
            ui.tracker.tableBody.addEventListener('change', e => {
                if (e.target.classList.contains('sell-price-input')) {
                    db.ref(`trackedFlips/${userId}/${e.target.dataset.id}/sellPrice`).set(parseInt(e.target.value, 10) || null);
                }
            });
            ui.tracker.tableBody.addEventListener('click', e => {
                if (e.target.classList.contains('remove-flip-btn')) {
                    db.ref(`trackedFlips/${userId}/${e.target.dataset.id}`).remove();
                }
            });
        }

        // --- Helper Functions ---
        function switchMainTab(tabName) {
            ui.tabs.forEach(t => t.classList.toggle('active', t.id === `main-tab-${tabName}`));
            ui.tabContents.forEach(c => c.classList.toggle('active', c.id === `${tabName}-content`));
            ui.sniperFiltersPanel.classList.toggle('hidden', tabName !== 'sniper');
            ui.trainingSniperFiltersPanel.classList.toggle('hidden', tabName !== 'training');
            if (tabName === 'home') fetchTrainingData();
        }

        function applyAllFilters() {
            const platform = currentConsole === 'xbox' ? 'xbox-series-x' : 'playstation-5';
            
            document.querySelectorAll('#sniperFeed .card-container').forEach(card => {
                let isVisible = card.dataset.console === platform;
                if (isVisible) {
                    isVisible = currentFilters.medians.includes(parseInt(card.dataset.medianType)) && 
                                parseInt(card.dataset.profit) >= currentFilters.minProfit && 
                                parseFloat(card.dataset.priceGap) >= currentFilters.priceGap;
                }
                card.style.display = isVisible ? 'block' : 'none';
            });

            document.querySelectorAll('#trainingSniperFeed .card-container').forEach(card => {
                let isVisible = card.dataset.console === platform;
                if (isVisible) {
                    isVisible = parseFloat(card.dataset.ratio) <= currentFilters.maxRatio;
                }
                card.style.display = isVisible ? 'block' : 'none';
            });

            document.querySelectorAll('#averageFeed .card-container').forEach(card => {
                card.style.display = card.dataset.console === platform ? 'block' : 'none';
            });
        }
        
        async function fetchTrainingData() {
            const platform = currentConsole === 'xbox' ? 'xbox-series-x' : 'playstation-5';
            const dbPath = `trainingData/${platform}`;

            if (isHost && sniperHelperReady) {
                const result = await fetchHelperData({ type: 'trainingData', platform });
                const data = result?.data?.trainingGuide;
                if (data?.length > 0) {
                    trainingDataCache = data;
                    db.ref(dbPath).set(data);
                }
            } else if (!isHost) {
                ui.homeFeed.textContent = 'Loading training data from database...';
                db.ref(dbPath).on('value', snapshot => {
                    trainingDataCache = snapshot.val();
                    renderTrainingData();
                });
                return; 
            }
            renderTrainingData();
        }

        function fetchHelperData(detail) {
            return new Promise(resolve => {
                const requestId = crypto.randomUUID();
                const listener = (event) => {
                    if (event.detail.requestId === requestId) {
                        document.removeEventListener('data-response-from-helper', listener);
                        if (event.detail.error) {
                            console.error(`Helper Error for type ${detail.type}:`, event.detail.error);
                            resolve(null);
                        } else {
                            resolve(event.detail.data);
                        }
                    }
                };
                document.addEventListener('data-response-from-helper', listener);
                document.dispatchEvent(new CustomEvent('request-data-from-helper', { detail: { ...detail, requestId } }));
            });
        }
        
        function updateTimestamps() {
            document.querySelectorAll('.card-container[data-timestamp]').forEach(card => {
                const timestamp = parseInt(card.dataset.timestamp, 10);
                if (!timestamp) return;
                const timeAgoEl = card.querySelector('.time-ago');
                if (!timeAgoEl) return;
                
                const secondsAgo = Math.round((Date.now() - timestamp) / 1000);
                if (secondsAgo < 2) {
                    timeAgoEl.textContent = `Just now`;
                } else if (secondsAgo < 60) {
                    timeAgoEl.textContent = `${secondsAgo}s ago`;
                } else {
                    timeAgoEl.textContent = `${Math.floor(secondsAgo / 60)}m ago`;
                }
            });
        }

        function cleanOldItems() {
            const now = Date.now();
            const clean = (map, path) => map.forEach((item, id) => {
                if (now - (item.timestamp || 0) > SNIPE_MAX_AGE_MS) {
                    const card = document.getElementById(id);
                    if (card) card.remove();
                    map.delete(id);
                    if (isHost) db.ref(`${path}/${id}`).remove();
                }
            });
            clean(allSnipes, 'snipes');
            clean(averageDeals, 'averageDeals');
            clean(trainingSnipes, 'trainingSnipes');
        }

        function calculateMedianOfLastNSales(data, n) {
            try {
                const sales = data.pricesData.completedAuctions;
                if (!sales || sales.length < n) return 0;
                const recent = sales.slice(0, n).map(a => Number(String(a.soldPrice).replace(/,/g,''))).filter(Number.isFinite);
                if (recent.length < n) return 0;
                const sorted = recent.sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return Math.round((sorted.length%2!==0 ? sorted[mid] : (sorted[mid-1]+sorted[mid])/2)/100)*100;
            } catch { return 0; }
        }

        // --- Start App ---
        initializeApp();
    });
    </script>
</body>
</html>